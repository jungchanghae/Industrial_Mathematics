% 태아심장모델
clc; clear all; close all;
global T TS TauS TauD;
%% 초기값 및 변수 설정
A = zeros(16,16);

% time
T = 1/150;
TS = T * 0.59;
dt = 0.01*T;
TauS = T * 0.39; %CRV
TauD = T * 0.41; %CRV
t0 = 0;
t1 = 100*T/dt;

% Resistance
R1 = 0.0091; %FPL - UV
R2 = 0.0355; %UV - IVC
R3 = 0.00204; %IVC - RA
R4 = 0.00357; %IVC - LA
R5 = (49.4-3.6)/563; %LA - AA 
R6 = 0.125; %AA - UB
R7 = 0.6; %AA - MY
R8 = 0.6; %AA - BR
R9 = 0.017; %UB - SVC
R10 = 0.15; %UB - IVC
R11 = 0.17; %MY - RA
R12 = 0.08; %BR - SVC
R13 = 0.7; %BR - IVC
R14 = 0.0029; %SVC - RA
R15 = 0.04; %SVC - LA
R16 = (51.6 - 4.2)/860; %RA - PA
R17 = 0.412; %PA - PV
R18 = 0.004; %PA - DA
R19 = 0.122; %PV - LA
R20 = 0.0067; %AA - DA
R21 = 0.577; %DA - IN
R22 = 0.144; %DA - LB
R23 = 0.053; %DA - FPL
R24 = 1.36; %DA - HE
R25 = 0.116; %IN - HE
R26 = 0.0208; %LB - IVC
R27 = 0.15; %LB - SVC
R28 = 0.027; %UV - HE
R29 = 0.0086; %HE - IVC

% Pressure mmHg
P1(1) = 20; 
P2(1) = 15.1;
P3(1) = 5.1;
P4(1) = 4.2;
P5(1) = 3.6;
P6(1) = 49.4;
P7(1) = 10.1; 
P8(1) = 14.1;
P9(1) = 9.9; 
P10(1) = 5.1; 
P11(1) = 51.6;
P12(1) = 14.5; 
P13(1) = 48.5;
P14(1) = 14.9;
P15(1) = 10;
P16(1) = 8.1;

% Complinance ml/mmHg
C1 = 1.4;
C2 = 0.3;
C3 = 0.2;
% C4 = 1;
% C5 = 1;
C6 = 0.07;
C7 = 0.9;
C8 = 0.25;
C9 = 0.6;
C10 = 0.1;
C11 = 0.25;
C12 = 0.25;
C13 = 0.14;
C14 = 0.25;
C15 = 1.4;
C16 = 3.0;

C4min = 3 * 0.2/50;
C4Max = 3 * 36.5/50;
C5min = 3 * 0.03/50;
C5Max = 3 * 14.6/50;
C4(1) = C_fun(0,C4min,C4Max);
C5(1) = C_fun(0,C5min,C5Max);

V1_0 = 32;
V2_0 = 10.5;
V3_0 = 39;
V4_0 = 6;
V5_0 = 6;
V6_0 = 11.5;
V7_0 = 16;
V8_0 = 1.25;
V9_0 = 9;
V10_0 = 19.5;
V11_0 = 4;
V12_0 = 1.25;
V13_0 = 23.14;
V14_0 = 0.25;
V15_0 = 26;
V16_0 = 1;

V1(1) = V1_0 + C1 * P1(1);
V2(1) = V2_0 + C2 * P2(1);
V3(1) = V3_0 + C3 * P3(1);
V4(1) = V4_0 + C4(1) * P4(1);
V5(1) = V5_0 + C5(1) * P5(1);
V6(1) = V6_0 + C6 * P6(1);
V7(1) = V7_0 + C7 * P7(1);
V8(1) = V8_0 + C8 * P8(1);
V9(1) = V9_0 + C9 * P9(1);
V10(1) = V10_0 + C10 * P10(1);
V11(1) = V11_0 + C11 * P11(1);
V12(1) = V12_0 + C12 * P12(1);
V13(1) = V13_0 + C13 * P13(1);
V14(1) = V14_0 + C14 * P14(1);
V15(1) = V15_0 + C15 * P15(1);
V16(1) = V16_0 + C16 * P16(1);
alV = V1(1) + V2(1) + V11(1) + V3(1) + V4(1)+ V5(1) + V6(1) + V7(1) + V8(1) + V9(1) + V10(1);

%%
time(1) = t0;
for i = 1 : t1
    time(i+1) = time(i) + dt;
    
    C4(i+1) = C_fun(time(i+1),C4min,C4Max);
    C5(i+1) = C_fun(time(i+1),C5min,C5Max);
    
    S1(i) = (P3(i) > P5(i));
    S2(i) = (P4(i) > P9(i));
    S3(i) = (P5(i) > P6(i));
    S4(i) = (P8(i) > P5(i));
    S1_temp = S1(i); S2_temp = S2(i); S3_temp = S3(i); S4_temp = S4(i);
    
    ok = 0;
    while ok ~= 20
        ok = ok+1;
        
        % dP1/dt
        A(1,1) = C1 + dt *(1/R1 + 1/R2);
        A(1,2) = -dt/R2;
        A(1,3) = 0;
        A(1,4) = 0;
        A(1,5) = 0;
        A(1,6) = 0;
        A(1,7) = 0;
        A(1,8) = 0;
        A(1,9) = 0;
        A(1,10) = -dt/R1;
        A(1,11) = 0;
        A(1,12) = ;
        A(1,13) = ;
        A(1,14) = ;
        A(1,15) = ;
        A(1,16) = ;
        
        % dP2/dt
        A(2,1) = -dt/R2;
        A(2,2) = C2 + dt * (1/R2 + 1/R3);
        A(2,3) = -dt/R3;
        A(2,4) = 0;
        A(2,5) = 0;
        A(2,6) = 0;
        A(2,7) = 0;
        A(2,8) = 0;
        A(2,9) = 0;
        A(2,10) = 0;
        A(2,11) = 0;
        A(2,12) = ;
        A(2,13) = ;
        A(2,14) = ;
        A(2,15) = ;
        A(2,16) = ;
        
        % dP3/dt
        A(3,1) = 0;
        A(3,2) = -dt/R3;
        A(3,3) = C3 + dt * (1/R3 + 1/R4 + S1_temp/R10 +1/R15);
        A(3,4) = -dt/R4;
        A(3,5) = -S1_temp * dt/R10;
        A(3,6) = 0;
        A(3,7) = 0;
        A(3,8) = 0;
        A(3,9) = 0;
        A(3,10) = 0;
        A(3,11) = -dt/R15;
        A(3,12) = ;
        A(3,13) = ;
        A(3,14) = ;
        A(3,15) = ;
        A(3,16) = ;
        
        % dP4/dt
        A(4,1) = 0;
        A(4,2) = 0;
        A(4,3) = -dt/R4;
        A(4,4) = C4(i+1) + dt * (1/R4 + 1/R8 + S2_temp/R11);
        A(4,5) = 0;
        A(4,6) = 0;
        A(4,7) = 0;
        A(4,8) = -dt/R8;
        A(4,9) = -S2_temp * dt/R11;
        A(4,10) = 0;
        A(4,11) = 0;
        A(4,12) = ;
        A(4,13) = ;
        A(4,14) = ;
        A(4,15) = ;
        A(4,16) = ;
        
        % dP5/dt  
        A(5,1) = 0;
        A(5,2) = 0;
        A(5,3) = -S1_temp * dt/R10;
        A(5,4) = 0;
        A(5,5) = C5(i+1) + dt * (S3_temp/R5 + S4_temp/R9 + S1_temp/R10);
        A(5,6) = -S3_temp * dt/R5;
        A(5,7) = 0;
        A(5,8) = -S4_temp * dt/R9;
        A(5,9) = 0;
        A(5,10) = 0;
        A(5,11) = 0;
        A(5,12) = ;
        A(5,13) = ;
        A(5,14) = ;
        A(5,15) = ;
        A(5,16) = ;
        
        % dP6/dt
        A(6,1) = 0;
        A(6,2) = 0;
        A(6,3) = 0;
        A(6,4) = 0;
        A(6,5) = -S3_temp * dt/R5;
        A(6,6) = C6 + dt * (S3_temp/R5 + 1/R6 + 1/R12);
        A(6,7) = -dt/R6;
        A(6,8) = 0;
        A(6,9) = 0;
        A(6,10) = -dt/R12;
        A(6,11) = 0;
        A(6,12) = ;
        A(6,13) = ;
        A(6,14) = ;
        A(6,15) = ;
        A(6,16) = ;
        
        % dP7/dt
        A(7,1) = 0;
        A(7,2) = 0;
        A(7,3) = 0;
        A(7,4) = 0;
        A(7,5) = 0;
        A(7,6) = -dt/R6;
        A(7,7) = C7 + dt * (1/R6 + 1/R7);
        A(7,8) = -dt/R7;
        A(7,9) = 0;
        A(7,10) = 0;
        A(7,11) = 0;
        A(7,12) = ;
        A(7,13) = ;
        A(7,14) = ;
        A(7,15) = ;
        A(7,16) = ;
        
        % dP8/dt
        A(8,1) = 0;
        A(8,2) = 0;
        A(8,3) = 0;
        A(8,4) = -dt/R8;
        A(8,5) = -S4_temp * dt/R9;
        A(8,6) = 0;
        A(8,7) = -dt/R7;
        A(8,8) = C8 + dt * (1/R7 + S4_temp/R9 + 1/R8);
        A(8,9) = 0;
        A(8,10) = 0;
        A(8,11) = 0;
        A(8,12) = ;
        A(8,13) = ;
        A(8,14) = ;
        A(8,15) = ;
        A(8,16) = ;
        
        % dP9/dt
        A(9,1) = 0;
        A(9,2) = 0;
        A(9,3) = 0;
        A(9,4) = -S2_temp * dt/R11;
        A(9,5) = 0;
        A(9,6) = 0;
        A(9,7) = 0;
        A(9,8) = 0;
        A(9,9) =  C9 + dt * (S2_temp/R11 + 1/R13);
        A(9,10) = -dt/R13;
        A(9,11) = 0;
        A(9,12) = ;
        A(9,13) = ;
        A(9,14) = ;
        A(9,15) = ;
        A(9,16) = ;
        
        % dP10/dt
        A(10,1) = -dt/R1;
        A(10,2) = 0;
        A(10,3) = 0;
        A(10,4) = 0;
        A(10,5) = 0;
        A(10,6) = -dt/R12;
        A(10,7) = 0;
        A(10,8) = 0;
        A(10,9) = -dt/R13;
        A(10,10) = C10 + dt * (1/R13 + 1/R14 + 1/R1 + 1/R12);
        A(10,11) = -dt/R14;
        A(10,12) = ;
        A(10,13) = ;
        A(10,14) = ;
        A(10,15) = ;
        A(10,16) = ;
        
        % dP11/dt
        A(11,1) = 0;
        A(11,2) = 0;
        A(11,3) = -dt/R15;
        A(11,4) = 0;
        A(11,5) = 0;
        A(11,6) = 0;
        A(11,7) = 0;
        A(11,8) = 0;
        A(11,9) = 0;
        A(11,10) = -dt/R14;
        A(11,11) = C11 + dt * (1/R14 + 1/R15);
        A(11,12) = ;
        A(11,13) = ;
        A(11,14) = ;
        A(11,15) = ;
        A(11,16) = ;
        
        % dP12/dt
        A(12,1) = C1 + dt *(1/R1 + 1/R2);
        A(12,2) = -dt/R2;
        A(12,3) = 0;
        A(12,4) = 0;
        A(12,5) = 0;
        A(12,6) = 0;
        A(12,7) = 0;
        A(12,8) = 0;
        A(12,9) = 0;
        A(12,10) = -dt/R1;
        A(12,11) = 0;
        A(12,12) = ;
        A(12,13) = ;
        A(12,14) = ;
        A(12,15) = ;
        A(12,16) = ;
        
        % dP13/dt
        A(13,1) = C1 + dt *(1/R1 + 1/R2);
        A(13,2) = -dt/R2;
        A(13,3) = 0;
        A(13,4) = 0;
        A(13,5) = 0;
        A(13,6) = 0;
        A(13,7) = 0;
        A(13,8) = 0;
        A(13,9) = 0;
        A(13,10) = -dt/R1;
        A(13,11) = 0;
        A(13,12) = ;
        A(13,13) = ;
        A(13,14) = ;
        A(13,15) = ;
        A(13,16) = ;
        
        % dP14/dt
        A(14,1) = C1 + dt *(1/R1 + 1/R2);
        A(14,2) = -dt/R2;
        A(14,3) = 0;
        A(14,4) = 0;
        A(14,5) = 0;
        A(14,6) = 0;
        A(14,7) = 0;
        A(14,8) = 0;
        A(14,9) = 0;
        A(14,10) = -dt/R1;
        A(14,11) = 0;
        A(14,12) = ;
        A(14,13) = ;
        A(14,14) = ;
        A(14,15) = ;
        A(14,16) = ;
        
        % dP15/dt
        A(15,1) = C1 + dt *(1/R1 + 1/R2);
        A(15,2) = -dt/R2;
        A(15,3) = 0;
        A(15,4) = 0;
        A(15,5) = 0;
        A(15,6) = 0;
        A(15,7) = 0;
        A(15,8) = 0;
        A(15,9) = 0;
        A(15,10) = -dt/R1;
        A(15,11) = 0;
        A(15,12) = ;
        A(15,13) = ;
        A(15,14) = ;
        A(15,15) = ;
        A(15,16) = ;
        
        % dP16/dt
        A(16,1) = C1 + dt *(1/R1 + 1/R2);
        A(16,2) = -dt/R2;
        A(16,3) = 0;
        A(16,4) = 0;
        A(16,5) = 0;
        A(16,6) = 0;
        A(16,7) = 0;
        A(16,8) = 0;
        A(16,9) = 0;
        A(16,10) = -dt/R1;
        A(16,11) = 0;
        A(16,12) = ;
        A(16,13) = ;
        A(16,14) = ;
        A(16,15) = ;
        A(16,16) = ;
        
        B = [C1*P1(i), C2*P2(i), C3*P3(i), C4(i+1)*P4(i), C5(i+1)*P5(i), C6*P6(i), C7*P7(i), C8*P8(i), C9*P9(i), C10*P10(i), C11*P11(i), C12*P12(i), C13*P13(i), C14*P14(i), C15*P15(i), C16*P16(i)];  
        X = A\B';
        
        P1(i+1) = X(1);
        P2(i+1) = X(2);
        P3(i+1) = X(3);
        P4(i+1) = X(4);
        P5(i+1) = X(5);
        P6(i+1) = X(6);
        P7(i+1) = X(7);
        P8(i+1) = X(8);
        P9(i+1) = X(9);
        P10(i+1) = X(10);
        P11(i+1) = X(11);
        P12(i+1) = X(12);
        P13(i+1) = X(13);
        P14(i+1) = X(14);
        P15(i+1) = X(15);
        P16(i+1) = X(16);
        
        V1(i+1) = V1_0 + C1 * P1(i+1);
        V2(i+1) = V2_0 + C2 * P2(i+1);
        V3(i+1) = V3_0 + C3 * P3(i+1);
        V4(i+1) = V4_0 + C4(i+1) * P4(i+1);
        V5(i+1) = V5_0 + C5(i+1) * P5(i+1);
        V6(i+1) = V6_0 + C6 * P6(i+1);
        V7(i+1) = V7_0 + C7 * P7(i+1);
        V8(i+1) = V8_0 + C8 * P8(i+1);
        V9(i+1) = V9_0 + C9 * P9(i+1);
        V10(i+1) = V10_0 + C10 * P10(i+1);
        V11(i+1) = V11_0 + C11 * P11(i+1);
        V12(i+1) = V12_0 + C12 * P12(i+1);
        V13(i+1) = V13_0 + C13 * P13(i+1);
        V14(i+1) = V14_0 + C14 * P14(i+1);
        V15(i+1) = V15_0 + C15 * P15(i+1);
        V16(i+1) = V16_0 + C16 * P16(i+1);
        
        
        
        S1(i+1) = (P3(i+1) > P5(i+1));
        S2(i+1) = (P4(i+1) > P9(i+1));
        S3(i+1) = (P5(i+1) > P6(i+1));
        S4(i+1) = (P8(i+1) > P5(i+1));
        
        if S1_temp == S1(i+1) && S2_temp == S2(i+1) && S3_temp == S3(i+1) && S4_temp == S4(i+1)
            ok = 20;
        else
            if ok == 1
                S1_temp = 0; S2_temp = 0; S3_temp = 0; S4_temp = 0;
            elseif ok == 2
                S1_temp = 0; S2_temp = 0; S3_temp = 0; S4_temp = 1;
            elseif ok == 3
                S1_temp = 0; S2_temp = 0; S3_temp = 1; S4_temp = 0;
            elseif ok == 4
                S1_temp = 0; S2_temp = 0; S3_temp = 1; S4_temp = 1;
            elseif ok == 5
                S1_temp = 0; S2_temp = 1; S3_temp = 0; S4_temp = 0;
            elseif ok == 6
                S1_temp = 0; S2_temp = 1; S3_temp = 0; S4_temp = 1;
            elseif ok == 7
                S1_temp = 0; S2_temp = 1; S3_temp = 1; S4_temp = 0;
            elseif ok == 8
                S1_temp = 0; S2_temp = 1; S3_temp = 1; S4_temp = 1;
            elseif ok == 9
                S1_temp = 1; S2_temp = 0; S3_temp = 0; S4_temp = 0;
            elseif ok == 10
                S1_temp = 1; S2_temp = 0; S3_temp = 0; S4_temp = 1;
            elseif ok == 11
                S1_temp = 1; S2_temp = 0; S3_temp = 1; S4_temp = 0;
            elseif ok == 12
                S1_temp = 1; S2_temp = 0; S3_temp = 1; S4_temp = 1;
            elseif ok == 13
                S1_temp = 1; S2_temp = 1; S3_temp = 0; S4_temp = 0;
            elseif ok == 14
                S1_temp = 1; S2_temp = 1; S3_temp = 0; S4_temp = 1;
            elseif ok == 15
                S1_temp = 1; S2_temp = 1; S3_temp = 1; S4_temp = 0;
            elseif ok == 16
                S1_temp = 1; S2_temp = 1; S3_temp = 1; S4_temp = 1;
            end
        end 
    end
end
allV = V1 + V2 + V11 + V3 + V4+ V5 + V6 + V7 + V8 + V9 + V10;
%% figure
figure
plot(time, P1,time, P2,time, P3,time, P4,time, P5,time, P6,time, P7,time, P8,'-.',time, P9,'-.',time,P10,'-.',time,P11,'-.','linewidth',1.5)
legend('1','2','3','4','5','6','7','8','9','10','11')
figure
plot(time, V1,time, V2,time, V3,time, V4,time, V5,time, V6,time, V7,time, V8,time, V9,time,V10,time,V11)
legend('1','2','3','4','5','6','7','8','9','10','11')
%%
figure
plot(time,C4,time,C5)
legend('4','5')