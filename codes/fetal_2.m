% 태아 심장모델 by compliance 식 없음 (9개) 
clc; clear all; close all;

%% 초기값 및 변수 설정
A = zeros(9,9);

% time
t0 = 0;
t1 = 500;
dt = 0.01;

% Resistance
R1 = 0.053;
R2 = 0.0091;
R3 = 0.0355;
R4 = 0.00204;
R5 = 0.0813;
R6 = 0.1303; 
%0.1156 0.1009
R7 = 0.0029;
R8 = 0.0551;
R9 = 0.004;
R10 = 0.00357;R11 = 0.04;
R12 = 0.0067;

% Pressure mmHg
P1(1) = 20.0 ; 
P2(1) = 15.1;
P3(1) = 5.1;
P4(1) = 4.2;
P5(1) = 3.6;
P6(1) = 49.4;
P7(1) = 5.1;
P8(1) = 51.6;
P9(1) = 48.5;

% Complinance ml/mmHg
C1(1) = 1.4;
C2(1) = 0.3;
C3(1) = 0.2;
C4(1) = 1.0;
C5(1) = 1.0;
C6(1) = 0.07;
C7(1) = 0.1;
C8(1) = 0.25;
C9(1) = 0.14;

% Volume
V1(1) = 60;
V2(1) = 15;
V3(1) = 40;
V4(1) = 10.2;
V5(1) = 9.6;
V6(1) = 15;
V7(1) = 20;
V8(1) = 16.9;
V9(1) = 29.9;

% Q : flows

Q1(1) = 539;
Q2(1) = 539;
Q3(1) = 280;
Q4(1) = 467;
Q5(1) = 563;
Q6(1) = 439;
Q7(1) = 334;
Q8(1) = 860;
Q9(1) = 770;
Q10(1) = 434;
Q11(1) = 39;
Q12(1) = 124;



S1(1) = (P5(1) > P6(1));
S2(1) = (P4(1) > P8(1));

%%
time(1) = 0;
for i = 1 : t1/dt
    time(i+1) = time(i) + dt;
    S1(i) = (P5(i) > P6(i));
    S2(i) = (P4(i) > P8(i));
    S1_temp = S1(i); S2_temp = S2(i);
    ok = 0;
    while ok ~= 6
        ok = ok+1;
        % dP1/dt
        A(1,1) = 1/C1 * (C1 + dt/R2 + dt/R1);
        A(1,2) = 1/C1 * (-dt/R2);
        A(1,3) = 0;
        A(1,4) = 0;
        A(1,5) = 0;
        A(1,6) = 0;
        A(1,7) = 0;
        A(1,8) = 0;
        A(1,9) = 1/C1 * (-dt/R1);
        
        % dP2/dt
        A(2,1) = 1/C2 * (-dt/R2);
        A(2,2) = 1/C2 * (dt/R2 + C2 + dt/R3);
        A(2,3) = 1/C2 * (-dt/R3);
        A(2,4) = 0;
        A(2,5) = 0;
        A(2,6) = 0;
        A(2,7) = 0;
        A(2,8) = 0;
        A(2,9) = 0;
        
        % dP3/dt
        A(3,1) = 0;
        A(3,2) = 1/C3 * (-dt/R3);
        A(3,3) = 1/C3 * (dt/R3 + C3 + dt/R4 + dt/R10);
        A(3,4) = 1/C3 * (-dt/R4);
        A(3,5) = 1/C3 *(-dt/R10);
        A(3,6) = 0;
        A(3,7) = 0;
        A(3,8) = 0;
        A(3,9) = 0;
        
        % dP4/dt
        A(4,1) = 0;
        A(4,2) = 0;
        A(4,3) = 1/C4(i) * (-dt/R4);
        A(4,4) = 1/C4(i) * (C4(i) + dt/R4 + S2_temp * dt / R8);
        A(4,5) = 0;
        A(4,6) = 0;
        A(4,7) = 0;
        A(4,8) = 1/C4(i) * (-S2_temp * dt/R8);
        A(4,9) = 0;
        
        % dP5/dt
        A(5,1) = 0;
        A(5,2) = 0;
        A(5,3) = 1/C5(i) * (-dt/R10);
        A(5,4) = 0;
        A(5,5) = 1/C5(i) * (C5(i) + dt/R10 + dt/R11 + S1_temp * dt/R5);
        A(5,6) = 1/C5(i) * (S1_temp * (-dt/R5));
        A(5,7) = 1/C5(i) * (-dt/R11);
        A(5,8) = 0;
        A(5,9) = 0;
        
        % dP6/dt
        A(6,1) = 0;
        A(6,2) = 0;
        A(6,3) = 0;
        A(6,4) = 0;
        A(6,5) = 1/C6 * (S1_temp * (-dt/R5));
        A(6,6) = 1/C6 * (C6 + S1_temp * dt/R5 + dt/R6 + dt/R12);
        A(6,7) = 1/C6 * (-dt/R6);
        A(6,8) = 0;
        A(6,9) = 1/C6 * (-dt/R12);
        
        % dP7/dt
        A(7,1) = 0;
        A(7,2) = 0;
        A(7,3) = 0;
        A(7,4) = 1/C7 * (-dt/R7);
        A(7,5) = 1/C7 * (-dt/R11);
        A(7,6) = 1/C7 * (-dt/R6);
        A(7,7) = 1/C7 * (C7 + dt/R6 + dt/R11 + dt/R7);
        A(7,8) = 0;
        A(7,9) = 0;
        
        % dP8/dt
        A(8,1) = 0;
        A(8,2) = 0;
        A(8,3) = 0;
        A(8,4) = 1/C8 * (C8 + S2_temp * dt/R8 + dt/R9);
        A(8,5) = 0;
        A(8,6) = 0;
        A(8,7) = 0;
        A(8,8) = 1/C8 * (-S2_temp * dt/R8);
        A(8,9) = 1/C8 * (-dt/R9);
        
        % dP9/dt
        A(9,1) = 1/C9 * (-dt/R1);
        A(9,2) = 0;
        A(9,3) = 0;
        A(9,4) = 0;
        A(9,5) = 0;
        A(9,6) = 1/C9 * (-dt/R12);
        A(9,7) = 0;
        A(9,8) = 1/C9 * (-dt/R9);
        A(9,9) = 1/C9 * (C9 + dt * (1/R12 + 1/R1 + 1/R9));
        
        B = [P1(i), P2(i), P3(i), P4(i), P5(i), P6(i), P7(i), P8(i), P9(i)];  
        X = inv(A) * B';
        
        P1(i+1) = X(1);
        P2(i+1) = X(2);
        P3(i+1) = X(3);
        P4(i+1) = X(4);
        P5(i+1) = X(5);
        P6(i+1) = X(6);
        P7(i+1) = X(7);
        P8(i+1) = X(8);
        P9(i+1) = X(9);
        
        S1(i+1) = (P5(i+1) > P6(i+1));
        S2(i+1) = (P4(i+1) > P8(i+1));
        
        if S1_temp == S1(i+1) && S2_temp == S2(i+1)
            ok = 6;
        else
            if ok == 1
                S1_temp = 0; S2_temp = 0;
            elseif ok == 2
                S1_temp = 1; S2_temp = 0;
            elseif ok == 3
                S1_temp = 0; S2_temp = 1;
            elseif ok == 4
                S1_temp = 1; S2_temp = 1;
            end
        end
        
        Q1(i+1) = (P9(i+1) - P1(i+1))/R1;
        Q2(i+1) = (P1(i+1) - P2(i+1))/R2;
        Q3(i+1) = (P2(i+1) - P3(i+1))/R3;
        Q4(i+1) = (P3(i+1) - P4(i+1))/R4;
        Q5(i+1) = (P5(i+1) - P6(i+1))/R5;
        Q6(i+1) = (P6(i+1) - P7(i+1))/R6;
        Q7(i+1) = (P7(i+1) - P4(i+1))/R7;
        Q8(i+1) = (P4(i+1) - P8(i+1))/R8;
        Q9(i+1) = (P8(i+1) - P9(i+1))/R9;
        Q10(i+1) = (P3(i+1) - P5(i+1))/R10;
        Q11(i+1) = (P7(i+1) - P5(i+1))/R11;
        Q12(i+1) = (P6(i+1) - P9(i+1))/R12;
        
        dV4 = dt * (Q4(i+1) - Q8(i+1));
        dV5 = dt * (Q10(i+1) - Q11(i+1) - Q5(i+1));
        
        C4(i+1) = (P4(i+1) - P4(i))/dV4;
        C5(i+1) = (P5(i+1) - P5(i))/dV5;

        
        
    end
end

%% figure

plot(time, P1)
